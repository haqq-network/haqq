<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gas and Fees | HAQQ Documentation</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" type="image/svg+xml" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
    <meta name="description" content="Learn about the differences between Gas and Fees in Ethereum and Cosmos.">
    <meta name="msapplication-TileColor" content="#2e3148">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.23f188c4.css" as="style"><link rel="preload" href="/assets/js/app.38831a15.js" as="script"><link rel="preload" href="/assets/js/30.d7ec603a.js" as="script"><link rel="preload" href="/assets/js/27.4737527f.js" as="script"><link rel="preload" href="/assets/js/25.6eba2827.js" as="script"><link rel="preload" href="/assets/js/31.5d89a875.js" as="script"><link rel="preload" href="/assets/js/56.f235578c.js" as="script"><link rel="preload" href="/assets/js/40.1f91466a.js" as="script"><link rel="preload" href="/assets/js/16.9b62e906.js" as="script"><link rel="preload" href="/assets/js/13.06c4e874.js" as="script"><link rel="preload" href="/assets/js/87.000220cc.js" as="script"><link rel="preload" href="/assets/js/5.4145d160.js" as="script"><link rel="preload" href="/assets/js/11.66108a36.js" as="script"><link rel="preload" href="/assets/js/38.b36b40da.js" as="script"><link rel="preload" href="/assets/js/19.efb83fa7.js" as="script"><link rel="preload" href="/assets/js/18.6c4ab24b.js" as="script"><link rel="preload" href="/assets/js/26.d6542a64.js" as="script"><link rel="prefetch" href="/assets/js/10.212a5a2d.js"><link rel="prefetch" href="/assets/js/100.7a5191a9.js"><link rel="prefetch" href="/assets/js/101.3ff7a628.js"><link rel="prefetch" href="/assets/js/102.8ae6cd6a.js"><link rel="prefetch" href="/assets/js/103.6254b7ab.js"><link rel="prefetch" href="/assets/js/104.45f39301.js"><link rel="prefetch" href="/assets/js/105.0442538b.js"><link rel="prefetch" href="/assets/js/106.5635b386.js"><link rel="prefetch" href="/assets/js/107.547489ef.js"><link rel="prefetch" href="/assets/js/108.86ff0584.js"><link rel="prefetch" href="/assets/js/109.c23c556b.js"><link rel="prefetch" href="/assets/js/110.cc946a40.js"><link rel="prefetch" href="/assets/js/111.d359be70.js"><link rel="prefetch" href="/assets/js/112.de46eb79.js"><link rel="prefetch" href="/assets/js/113.d42cf0cd.js"><link rel="prefetch" href="/assets/js/114.d448ab9d.js"><link rel="prefetch" href="/assets/js/115.b335fb22.js"><link rel="prefetch" href="/assets/js/116.695f3029.js"><link rel="prefetch" href="/assets/js/117.250acd4c.js"><link rel="prefetch" href="/assets/js/118.027f9378.js"><link rel="prefetch" href="/assets/js/119.4ee1f383.js"><link rel="prefetch" href="/assets/js/12.753f2080.js"><link rel="prefetch" href="/assets/js/120.8d1768cb.js"><link rel="prefetch" href="/assets/js/121.9f629321.js"><link rel="prefetch" href="/assets/js/122.f90ee60e.js"><link rel="prefetch" href="/assets/js/123.07aac9dd.js"><link rel="prefetch" href="/assets/js/124.d7cf34c4.js"><link rel="prefetch" href="/assets/js/125.d5bebfcb.js"><link rel="prefetch" href="/assets/js/126.9e9c202e.js"><link rel="prefetch" href="/assets/js/127.f76ae248.js"><link rel="prefetch" href="/assets/js/128.4c19f548.js"><link rel="prefetch" href="/assets/js/129.fb8c22e0.js"><link rel="prefetch" href="/assets/js/130.69a313e9.js"><link rel="prefetch" href="/assets/js/131.b6ac385e.js"><link rel="prefetch" href="/assets/js/132.00045f0c.js"><link rel="prefetch" href="/assets/js/133.ef2fff88.js"><link rel="prefetch" href="/assets/js/134.0061578f.js"><link rel="prefetch" href="/assets/js/135.5a8f6b10.js"><link rel="prefetch" href="/assets/js/136.07037c56.js"><link rel="prefetch" href="/assets/js/137.05ff38cb.js"><link rel="prefetch" href="/assets/js/138.5401caa3.js"><link rel="prefetch" href="/assets/js/139.b9a6e45e.js"><link rel="prefetch" href="/assets/js/14.7852583c.js"><link rel="prefetch" href="/assets/js/140.b5e5edd5.js"><link rel="prefetch" href="/assets/js/141.5acde3b7.js"><link rel="prefetch" href="/assets/js/142.bd2511e4.js"><link rel="prefetch" href="/assets/js/143.3017a068.js"><link rel="prefetch" href="/assets/js/144.7ab4a956.js"><link rel="prefetch" href="/assets/js/145.4e1c2131.js"><link rel="prefetch" href="/assets/js/146.81413300.js"><link rel="prefetch" href="/assets/js/147.98429472.js"><link rel="prefetch" href="/assets/js/148.4bc07849.js"><link rel="prefetch" href="/assets/js/149.f5a12ec4.js"><link rel="prefetch" href="/assets/js/15.1a03b911.js"><link rel="prefetch" href="/assets/js/150.48036cb9.js"><link rel="prefetch" href="/assets/js/151.6133172b.js"><link rel="prefetch" href="/assets/js/152.9dc6fb55.js"><link rel="prefetch" href="/assets/js/153.ea0220f0.js"><link rel="prefetch" href="/assets/js/154.b8ff33be.js"><link rel="prefetch" href="/assets/js/155.2746da96.js"><link rel="prefetch" href="/assets/js/156.db86da8b.js"><link rel="prefetch" href="/assets/js/157.0d66702b.js"><link rel="prefetch" href="/assets/js/158.e90596cf.js"><link rel="prefetch" href="/assets/js/159.a7cb160d.js"><link rel="prefetch" href="/assets/js/160.71e8b7b8.js"><link rel="prefetch" href="/assets/js/161.a2adcc56.js"><link rel="prefetch" href="/assets/js/162.1e2faad2.js"><link rel="prefetch" href="/assets/js/163.3bc6a690.js"><link rel="prefetch" href="/assets/js/164.ddc34ef5.js"><link rel="prefetch" href="/assets/js/165.2807cc8a.js"><link rel="prefetch" href="/assets/js/166.a6d0877a.js"><link rel="prefetch" href="/assets/js/167.78475872.js"><link rel="prefetch" href="/assets/js/168.e4c77bed.js"><link rel="prefetch" href="/assets/js/169.541b1e6d.js"><link rel="prefetch" href="/assets/js/17.679028b0.js"><link rel="prefetch" href="/assets/js/170.ad493cb7.js"><link rel="prefetch" href="/assets/js/171.e1f02172.js"><link rel="prefetch" href="/assets/js/172.55c303dc.js"><link rel="prefetch" href="/assets/js/173.4c19a682.js"><link rel="prefetch" href="/assets/js/174.5c430f70.js"><link rel="prefetch" href="/assets/js/175.93e50020.js"><link rel="prefetch" href="/assets/js/176.dd1e2ab9.js"><link rel="prefetch" href="/assets/js/177.fc3304df.js"><link rel="prefetch" href="/assets/js/178.b4435f32.js"><link rel="prefetch" href="/assets/js/179.5422e948.js"><link rel="prefetch" href="/assets/js/180.f2851cf5.js"><link rel="prefetch" href="/assets/js/181.795d981e.js"><link rel="prefetch" href="/assets/js/182.3a8a657d.js"><link rel="prefetch" href="/assets/js/183.8608ef5a.js"><link rel="prefetch" href="/assets/js/184.08d76ec2.js"><link rel="prefetch" href="/assets/js/185.0220c9d0.js"><link rel="prefetch" href="/assets/js/186.bcea50ed.js"><link rel="prefetch" href="/assets/js/187.96c0ec7d.js"><link rel="prefetch" href="/assets/js/188.4d620aea.js"><link rel="prefetch" href="/assets/js/189.5e1def67.js"><link rel="prefetch" href="/assets/js/190.82ecd271.js"><link rel="prefetch" href="/assets/js/191.7e745cfb.js"><link rel="prefetch" href="/assets/js/192.83f07f8a.js"><link rel="prefetch" href="/assets/js/193.f3d0708b.js"><link rel="prefetch" href="/assets/js/194.b26cda69.js"><link rel="prefetch" href="/assets/js/195.0092d499.js"><link rel="prefetch" href="/assets/js/196.07dbc409.js"><link rel="prefetch" href="/assets/js/197.378e62e1.js"><link rel="prefetch" href="/assets/js/198.3c6722fa.js"><link rel="prefetch" href="/assets/js/199.f5b92701.js"><link rel="prefetch" href="/assets/js/2.cf931574.js"><link rel="prefetch" href="/assets/js/20.db5db551.js"><link rel="prefetch" href="/assets/js/200.2f5c5b48.js"><link rel="prefetch" href="/assets/js/201.9322b0fa.js"><link rel="prefetch" href="/assets/js/202.1542f6ba.js"><link rel="prefetch" href="/assets/js/203.3cb2fc2c.js"><link rel="prefetch" href="/assets/js/204.54e3c0d2.js"><link rel="prefetch" href="/assets/js/205.316fe06f.js"><link rel="prefetch" href="/assets/js/206.a0b40323.js"><link rel="prefetch" href="/assets/js/207.426e8493.js"><link rel="prefetch" href="/assets/js/208.bbfebcf7.js"><link rel="prefetch" href="/assets/js/209.c208167f.js"><link rel="prefetch" href="/assets/js/21.195f51d0.js"><link rel="prefetch" href="/assets/js/210.eeb276af.js"><link rel="prefetch" href="/assets/js/211.3097cda2.js"><link rel="prefetch" href="/assets/js/212.b7ba21db.js"><link rel="prefetch" href="/assets/js/213.bafd54ab.js"><link rel="prefetch" href="/assets/js/214.7497f8c2.js"><link rel="prefetch" href="/assets/js/22.3d96a3aa.js"><link rel="prefetch" href="/assets/js/23.6bc2267a.js"><link rel="prefetch" href="/assets/js/24.c6880f3c.js"><link rel="prefetch" href="/assets/js/28.a6a775b9.js"><link rel="prefetch" href="/assets/js/29.b4c69bab.js"><link rel="prefetch" href="/assets/js/3.7a8a44fd.js"><link rel="prefetch" href="/assets/js/32.a6e86c46.js"><link rel="prefetch" href="/assets/js/33.effb123d.js"><link rel="prefetch" href="/assets/js/34.9df2dee9.js"><link rel="prefetch" href="/assets/js/35.894aa7db.js"><link rel="prefetch" href="/assets/js/36.70501853.js"><link rel="prefetch" href="/assets/js/37.60aaee2a.js"><link rel="prefetch" href="/assets/js/39.d6481eea.js"><link rel="prefetch" href="/assets/js/4.0d73ede0.js"><link rel="prefetch" href="/assets/js/41.f2643fa5.js"><link rel="prefetch" href="/assets/js/42.1026d1e0.js"><link rel="prefetch" href="/assets/js/43.566b0d04.js"><link rel="prefetch" href="/assets/js/44.32794d1c.js"><link rel="prefetch" href="/assets/js/45.c855668b.js"><link rel="prefetch" href="/assets/js/46.9031f4e8.js"><link rel="prefetch" href="/assets/js/47.0329a906.js"><link rel="prefetch" href="/assets/js/48.a6b3f842.js"><link rel="prefetch" href="/assets/js/49.b5502e76.js"><link rel="prefetch" href="/assets/js/50.39d93f1c.js"><link rel="prefetch" href="/assets/js/51.b6068b1b.js"><link rel="prefetch" href="/assets/js/52.3b2d4112.js"><link rel="prefetch" href="/assets/js/53.c76e2064.js"><link rel="prefetch" href="/assets/js/54.9c78cc49.js"><link rel="prefetch" href="/assets/js/55.c5b83689.js"><link rel="prefetch" href="/assets/js/57.224116ac.js"><link rel="prefetch" href="/assets/js/58.3dab81fc.js"><link rel="prefetch" href="/assets/js/59.d75d0cc4.js"><link rel="prefetch" href="/assets/js/6.0b8bbcd4.js"><link rel="prefetch" href="/assets/js/60.57b8d34f.js"><link rel="prefetch" href="/assets/js/61.b6b4ead6.js"><link rel="prefetch" href="/assets/js/62.ed464fb8.js"><link rel="prefetch" href="/assets/js/63.278ad337.js"><link rel="prefetch" href="/assets/js/64.5bbf80d7.js"><link rel="prefetch" href="/assets/js/65.e1a0d9af.js"><link rel="prefetch" href="/assets/js/66.d586cac5.js"><link rel="prefetch" href="/assets/js/67.9fe43ca2.js"><link rel="prefetch" href="/assets/js/68.786342ec.js"><link rel="prefetch" href="/assets/js/69.cbc5d5dd.js"><link rel="prefetch" href="/assets/js/7.942b713b.js"><link rel="prefetch" href="/assets/js/70.d4a1b88c.js"><link rel="prefetch" href="/assets/js/71.abfff3fb.js"><link rel="prefetch" href="/assets/js/72.6e2743a7.js"><link rel="prefetch" href="/assets/js/73.436508ae.js"><link rel="prefetch" href="/assets/js/74.f2a52caa.js"><link rel="prefetch" href="/assets/js/75.0799ef1d.js"><link rel="prefetch" href="/assets/js/76.89e3c113.js"><link rel="prefetch" href="/assets/js/77.4157cabb.js"><link rel="prefetch" href="/assets/js/78.22b285de.js"><link rel="prefetch" href="/assets/js/79.49c76589.js"><link rel="prefetch" href="/assets/js/8.fe18dd03.js"><link rel="prefetch" href="/assets/js/80.4dbffda5.js"><link rel="prefetch" href="/assets/js/81.4d91d090.js"><link rel="prefetch" href="/assets/js/82.d04c9970.js"><link rel="prefetch" href="/assets/js/83.bf0e6353.js"><link rel="prefetch" href="/assets/js/84.f3449691.js"><link rel="prefetch" href="/assets/js/85.4bde82b0.js"><link rel="prefetch" href="/assets/js/86.5bcb783d.js"><link rel="prefetch" href="/assets/js/88.08322eda.js"><link rel="prefetch" href="/assets/js/89.5f21ee73.js"><link rel="prefetch" href="/assets/js/9.0c74d9b4.js"><link rel="prefetch" href="/assets/js/90.c1f0d242.js"><link rel="prefetch" href="/assets/js/91.ca98be5e.js"><link rel="prefetch" href="/assets/js/92.b052302a.js"><link rel="prefetch" href="/assets/js/93.3417adc4.js"><link rel="prefetch" href="/assets/js/94.6157e529.js"><link rel="prefetch" href="/assets/js/95.07c75c60.js"><link rel="prefetch" href="/assets/js/96.08e4b016.js"><link rel="prefetch" href="/assets/js/97.edc00bad.js"><link rel="prefetch" href="/assets/js/98.52f6e6fd.js"><link rel="prefetch" href="/assets/js/99.233d8295.js">
    <link rel="stylesheet" href="/assets/css/0.styles.23f188c4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-v-58560e81><div data-v-40401285 data-v-58560e81><div class="banner-wrapper" data-v-40401285 data-v-40401285><div class="wrapper" data-v-40401285><div class="message" data-v-40401285>By using this website, you agree to our <a href="https://www.cookiesandyou.com" target="_blank" rel="noopener" style="color:#505FFF;" data-v-40401285>Cookie Policy</a>.</div> <div class="box" data-v-40401285><span class="icon-cross" data-v-40401285><svg width="16" height="16" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-40401285><path d="M1.66669 1.66669L12.3334 12.3334M12.3334 1.66669L1.66664 12.3334" stroke="#A2A3AD" stroke-width="1.5" stroke-linecap="round" data-v-40401285></path></svg></span></div></div></div></div><!----><div class="layout" data-v-58560e81><div class="layout__sidebar" data-v-58560e81><div style="height:100%;position:relative;" data-v-25cba946 data-v-58560e81><div class="container" data-v-25cba946><a href="/" class="logo__container router-link-active" data-v-25cba946><div class="logo" data-v-25cba946><div class="logo__img__custom" data-v-25cba946><img src="/haqq_logo.svg" data-v-25cba946></div><!----></div></a><div class="items footer__compact__false" data-v-25cba946><div class="sidebar" style="display:none;" data-v-25cba946><div class="title" data-v-25cba946></div><!----></div><div class="sidebar" style="display:block;" data-v-25cba946><div class="title" data-v-25cba946>Reference</div><!----></div><div class="sidebar" style="display:block;" data-v-25cba946><div class="title" data-v-25cba946>Guides</div><!----></div><div class="sidebar" style="display:block;" data-v-25cba946><div class="title" data-v-25cba946>APIs</div><!----></div><div class="sidebar" style="display:block;" data-v-25cba946><div class="title" data-v-25cba946>Testnet</div><!----></div><div class="sidebar" style="display:block;" data-v-25cba946><div class="title" data-v-25cba946>Specifications</div><!----></div><div class="sidebar" style="display:block;" data-v-25cba946><div class="title" data-v-25cba946>Block Explorers</div><!----></div><div class="sidebar" style="display:block;" data-v-25cba946><div class="title" data-v-25cba946>Resources</div><!----></div><div class="sidebar version" data-v-25cba946><div data-v-08503e1b data-v-25cba946><div class="container" data-v-08503e1b><span class="sr-only" data-v-08503e1b>Docs Version Switcher</span><!----></div></div></div></div><!----></div></div></div><div class="layout__main" data-v-58560e81><div class="layout__main__navbar" data-v-58560e81><div data-v-19189c02 data-v-58560e81><div class="container" data-v-19189c02><div class="menu" data-v-19189c02><div class="menu__icon" data-v-19189c02><svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#888" data-v-19189c02><path d="M2 5H22M2 12H22M2 19H22" stroke-width="1.5" stroke-linecap="round"></path></svg></div></div><div class="logo" data-v-19189c02><div class="logo__wrapper router-link-active" data-v-19189c02><div class="logo__image__custom" data-v-19189c02><img src="/haqq_logo.svg" class="logo__image__custom__img" data-v-19189c02></div><!----></div></div><div class="toolbar" data-v-19189c02><div class="toolbar__item" data-v-19189c02><div class="toolbar__item__icon" data-v-19189c02><svg width="100%" height="100%" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#888" data-v-19189c02><path fill-rule="evenodd" clip-rule="evenodd" d="M11.5 2.75C6.66751 2.75 2.75 6.66751 2.75 11.5C2.75 16.3325 6.66751 20.25 11.5 20.25C13.6462 20.25 15.612 19.4773 17.1342 18.1949L22.6697 23.7303C22.9626 24.0232 23.4374 24.0232 23.7303 23.7303C24.0232 23.4374 24.0232 22.9626 23.7303 22.6697L18.1949 17.1342C19.4773 15.612 20.25 13.6462 20.25 11.5C20.25 6.66751 16.3325 2.75 11.5 2.75ZM16.6923 16.5599C17.9656 15.2535 18.75 13.4684 18.75 11.5C18.75 7.49594 15.5041 4.25 11.5 4.25C7.49594 4.25 4.25 7.49594 4.25 11.5C4.25 15.5041 7.49594 18.75 11.5 18.75C13.4684 18.75 15.2535 17.9656 16.5599 16.6923C16.5789 16.6679 16.5996 16.6444 16.622 16.622C16.6444 16.5996 16.6679 16.5789 16.6923 16.5599Z"></path></svg></div></div></div></div></div></div><div class="layout__main__content aside__true" data-v-58560e81><div id="content-scroll" class="layout__main__content__body" data-v-58560e81><div class="layout__main__content__body__breadcrumbs" data-v-58560e81><div data-v-48fb2d7a data-v-58560e81><div class="container" data-v-48fb2d7a><div class="crumbs" data-v-48fb2d7a><a href="/" class="crumbs__item router-link-active" data-v-48fb2d7a>HAQQ Documentation</a><a href="/basics/" class="crumbs__item router-link-active" data-v-48fb2d7a>Basics</a><a href="/basics/gas.html" aria-current="page" class="crumbs__item router-link-exact-active router-link-active" data-v-48fb2d7a>Gas and Fees</a></div><div class="menu" data-v-48fb2d7a><div class="menu__item" style="visibility:visible;" data-v-48fb2d7a><svg width="100%" height="100%" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="menu__item__icon menu__item__icon__active__false" data-v-48fb2d7a><path fill-rule="evenodd" clip-rule="evenodd" d="M0.25 2C0.25 1.58579 0.585786 1.25 1 1.25H6C6.41421 1.25 6.75 1.58579 6.75 2C6.75 2.41421 6.41421 2.75 6 2.75H1C0.585786 2.75 0.25 2.41421 0.25 2ZM17.53 22.7803L16.9997 22.25L17.53 22.7803L17.5301 22.7802L17.5305 22.7798L17.5322 22.7781L17.5388 22.7715L17.5647 22.7456L17.6647 22.6456L18.0367 22.2737L19.2978 21.0126L22.53 17.7803C22.8229 17.4874 22.8229 17.0126 22.53 16.7197C22.2371 16.4268 21.7622 16.4268 21.4693 16.7197L18.2371 19.9519L17.7497 20.4393V8.5C17.7497 6.34186 17.0721 4.51182 15.7802 3.21983C14.4882 1.92783 12.6581 1.25031 10.5 1.25031C10.0858 1.25031 9.75 1.5861 9.75 2.00031C9.75 2.41453 10.0858 2.75031 10.5 2.75031C12.3419 2.75031 13.7617 3.32264 14.7195 4.28049C15.6773 5.23834 16.2497 6.65814 16.2497 8.5L16.2497 20.4393L12.53 16.7197C12.2371 16.4268 11.7622 16.4268 11.4693 16.7197C11.1764 17.0126 11.1764 17.4874 11.4693 17.7803L16.4693 22.7803L16.9997 23.3107L17.53 22.7803ZM1 6.25C0.585786 6.25 0.25 6.58579 0.25 7C0.25 7.41421 0.585786 7.75 1 7.75H10C10.4142 7.75 10.75 7.41421 10.75 7C10.75 6.58579 10.4142 6.25 10 6.25H1ZM0.25 12C0.25 11.5858 0.585786 11.25 1 11.25H12C12.4142 11.25 12.75 11.5858 12.75 12C12.75 12.4142 12.4142 12.75 12 12.75H1C0.585786 12.75 0.25 12.4142 0.25 12ZM1 16.25C0.585786 16.25 0.25 16.5858 0.25 17C0.25 17.4142 0.585786 17.75 1 17.75H8C8.41421 17.75 8.75 17.4142 8.75 17C8.75 16.5858 8.41421 16.25 8 16.25H1Z" data-v-48fb2d7a></path></svg><!----></div></div></div></div></div><div class="layout__main__content__body__wrapper" data-v-58560e81><div style="width:100%;" data-v-c85ed208 data-v-58560e81><div class="search__container" data-v-c85ed208><div class="search" data-v-c85ed208><div class="search__icon" data-v-c85ed208><svg width="100%" height="100%" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-v-c85ed208><path fill-rule="evenodd" clip-rule="evenodd" d="M11.5 2.75C6.66751 2.75 2.75 6.66751 2.75 11.5C2.75 16.3325 6.66751 20.25 11.5 20.25C13.6462 20.25 15.612 19.4773 17.1342 18.1949L22.6697 23.7303C22.9626 24.0232 23.4374 24.0232 23.7303 23.7303C24.0232 23.4374 24.0232 22.9626 23.7303 22.6697L18.1949 17.1342C19.4773 15.612 20.25 13.6462 20.25 11.5C20.25 6.66751 16.3325 2.75 11.5 2.75ZM16.6923 16.5599C17.9656 15.2535 18.75 13.4684 18.75 11.5C18.75 7.49594 15.5041 4.25 11.5 4.25C7.49594 4.25 4.25 7.49594 4.25 11.5C4.25 15.5041 7.49594 18.75 11.5 18.75C13.4684 18.75 15.2535 17.9656 16.5599 16.6923C16.5789 16.6679 16.5996 16.6444 16.622 16.622C16.6444 16.5996 16.6679 16.5789 16.6923 16.5599Z"></path></svg></div><div class="search__text" data-v-c85ed208>Search</div></div></div><div class="container" data-v-c85ed208><div class="content__default" data-v-58560e81><h1 id="gas-and-fees"><a href="#gas-and-fees" class="header-anchor">#</a> Gas and Fees</h1> <p synopsis="">Learn about the differences between <code>Gas</code> and <code>Fees</code> in Ethereum and Cosmos.</p> <h2 id="pre-requisite-readings"><a href="#pre-requisite-readings" class="header-anchor">#</a> Pre-requisite Readings</h2> <ul><li prereq=""><a href="https://docs.cosmos.network/master/basics/gas-fees.html" target="_blank" rel="noopener noreferrer">Cosmos SDK Gas<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li prereq=""><a href="https://ethereum.org/en/developers/docs/gas/" target="_blank" rel="noopener noreferrer">Ethereum Gas<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>The concept of Gas represents the amount of computational effort required to execute specific operations on the state machine.</p> <p>Gas was created on Ethereum to disallow the EVM (Ethereum Virtual Machine) from running infinite
loops by allocating a small amount of monetary value into the system. A unit of gas, usually in the
form of a fraction of the native coin, is consumed for every operation on the EVM and requires a
user to pay for these operations. These operations consist in state transitions such as sending a
transaction or calling a contract.</p> <p>Exactly like Ethereum, Cosmos utilizes the concept of gas and this is how Cosmos tracks the resource
usage of operations during execution. Operations on Cosmos are represented as read or writes done to the chain's store.</p> <p>In Cosmos, a fee is calculated and charged to the user during a message execution. This fee is
calculated from the sum of all gas consumed in a message execution:</p> <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>f</mi><mi>e</mi><mi>e</mi><mo>=</mo><mi>g</mi><mi>a</mi><mi>s</mi><mtext></mtext><mo>∗</mo><mtext></mtext><mi>g</mi><mi>a</mi><mi>s</mi><mi>P</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">fee = gas ~ * ~ gasPrice
</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mord mathit">e</span><span class="mord mathit">e</span><span class="mrel">=</span><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="mord mathit">a</span><span class="mord mathit">s</span><span class="mord mspace"></span><span class="mbin">∗</span><span class="mord mspace"></span><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="mord mathit">a</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="mord mathit" style="margin-right:0.02778em;">r</span><span class="mord mathit">i</span><span class="mord mathit">c</span><span class="mord mathit">e</span></span></span></span></span></p> <p>In both networks, gas is used to make sure that operations do not require an excess amount of
computational power to complete and as a way to deter bad-acting users from spamming the network.</p> <h2 id="cosmos-sdk-gas"><a href="#cosmos-sdk-gas" class="header-anchor">#</a> Cosmos SDK <code>Gas</code></h2> <p>In the Cosmos SDK, gas is tracked in the main <code>GasMeter</code> and the <code>BlockGasMeter</code>:</p> <ul><li><code>GasMeter</code>: keeps track of the gas consumed during executions that lead to state transitions. It is reset on every transaction execution.</li> <li><code>BlockGasMeter</code>: keeps track of the gas consumed in a block and enforces that the gas does not go over a predefined limit. This limit is defined in the Tendermint consensus parameters and can be changed via governance parameter change proposals.</li></ul> <p>More information regarding gas in Cosmos SDK can be found <a href="https://docs.cosmos.network/master/basics/gas-fees.html" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="matching-evm-gas-consumption"><a href="#matching-evm-gas-consumption" class="header-anchor">#</a> Matching EVM Gas consumption</h2> <p>Haqq is an EVM-compatible chain that supports Ethereum Web3 tooling. For this reason, gas
consumption must be equitable with other EVMs, most importantly Ethereum.</p> <p>The main difference between EVM and Cosmos state transitions, is that the EVM uses a <a href="https://github.com/ethereum/go-ethereum/blob/master/params/protocol_params.go" target="_blank" rel="noopener noreferrer">gas table<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for each OPCODE, whereas Cosmos uses a <code>GasConfig</code> that charges gas for each CRUD operation by setting a flat and per-byte cost for accessing the database.</p> <p><span class="codeblock" data-v-1eda75b2><span class="container codeblock__hasfooter__false codeblock__is-expandable__false codeblock__expanded__false" data-v-1eda75b2><span class="body__container" data-v-1eda75b2><span class="body__block" data-v-1eda75b2><span class="icons" data-v-1eda75b2><!----> <span class="icons__item" data-v-1eda75b2><svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="icons__item__icon" data-v-1eda75b2><path fill-rule="evenodd" clip-rule="evenodd" d="M11 0.25C10.0335 0.25 9.25 1.0335 9.25 2V4.5H10.75V2C10.75 1.86193 10.8619 1.75 11 1.75H21C21.1381 1.75 21.25 1.86193 21.25 2V16C21.25 16.1381 21.1381 16.25 21 16.25H16.5V17.75H21C21.9665 17.75 22.75 16.9665 22.75 16V2C22.75 1.0335 21.9665 0.25 21 0.25H11ZM3 6.25C2.0335 6.25 1.25 7.0335 1.25 8V22C1.25 22.9665 2.0335 23.75 3 23.75H13C13.9665 23.75 14.75 22.9665 14.75 22V8C14.75 7.0335 13.9665 6.25 13 6.25H3ZM2.75 8C2.75 7.86193 2.86193 7.75 3 7.75H13C13.1381 7.75 13.25 7.86193 13.25 8V22C13.25 22.1381 13.1381 22.25 13 22.25H3C2.86193 22.25 2.75 22.1381 2.75 22V8Z" data-v-1eda75b2></path></svg> <span class="icons__item__tooltip" data-v-1eda75b2>
              Copy
            </span></span></span> <span class="body" data-v-1eda75b2><span class="body__wrapper" data-v-1eda75b2><span class="body__code" data-v-1eda75b2><span class="token comment">// GasConfig defines gas cost for each operation on KVStores</span>
<span class="token keyword">type</span> GasConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	HasCost          Gas
	DeleteCost       Gas
	ReadCostFlat     Gas
	ReadCostPerByte  Gas
	WriteCostFlat    Gas
	WriteCostPerByte Gas
	IterNextCostFlat Gas
<span class="token punctuation">}</span></span></span></span></span> <!----></span> <!----></span></span></p> <p>In order to match the gas consumed by the EVM, the gas consumption logic from the SDK is ignored, and instead the gas consumed is calculated by subtracting the state transition leftover gas plus refund from the gas limit defined on the message.</p> <p>To ignore the SDK gas consumption, we reset the transaction <code>GasMeter</code> count to 0 and manually set it to the <code>gasUsed</code> value computed by the EVM module at the end of the execution.</p> <p><span class="codeblock" data-v-1eda75b2><span class="container codeblock__hasfooter__false codeblock__is-expandable__false codeblock__expanded__false" data-v-1eda75b2><span class="body__container" data-v-1eda75b2><span class="body__block" data-v-1eda75b2><span class="icons" data-v-1eda75b2><!----> <span class="icons__item" data-v-1eda75b2><svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="icons__item__icon" data-v-1eda75b2><path fill-rule="evenodd" clip-rule="evenodd" d="M11 0.25C10.0335 0.25 9.25 1.0335 9.25 2V4.5H10.75V2C10.75 1.86193 10.8619 1.75 11 1.75H21C21.1381 1.75 21.25 1.86193 21.25 2V16C21.25 16.1381 21.1381 16.25 21 16.25H16.5V17.75H21C21.9665 17.75 22.75 16.9665 22.75 16V2C22.75 1.0335 21.9665 0.25 21 0.25H11ZM3 6.25C2.0335 6.25 1.25 7.0335 1.25 8V22C1.25 22.9665 2.0335 23.75 3 23.75H13C13.9665 23.75 14.75 22.9665 14.75 22V8C14.75 7.0335 13.9665 6.25 13 6.25H3ZM2.75 8C2.75 7.86193 2.86193 7.75 3 7.75H13C13.1381 7.75 13.25 7.86193 13.25 8V22C13.25 22.1381 13.1381 22.25 13 22.25H3C2.86193 22.25 2.75 22.1381 2.75 22V8Z" data-v-1eda75b2></path></svg> <span class="icons__item__tooltip" data-v-1eda75b2>
              Copy
            </span></span></span> <span class="body" data-v-1eda75b2><span class="body__wrapper" data-v-1eda75b2><span class="body__code" data-v-1eda75b2><span class="token keyword">package</span> keeper

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"math/big"</span>

	errorsmod <span class="token string">"cosmossdk.io/errors"</span>
	tmtypes <span class="token string">"github.com/cometbft/cometbft/types"</span>
	sdk <span class="token string">"github.com/cosmos/cosmos-sdk/types"</span>
	<span class="token string">"github.com/ethereum/go-ethereum/common"</span>
	<span class="token string">"github.com/ethereum/go-ethereum/core"</span>
	ethtypes <span class="token string">"github.com/ethereum/go-ethereum/core/types"</span>
	<span class="token string">"github.com/ethereum/go-ethereum/core/vm"</span>
	<span class="token string">"github.com/ethereum/go-ethereum/crypto"</span>
	<span class="token string">"github.com/ethereum/go-ethereum/params"</span>

	haqqtypes <span class="token string">"github.com/haqq-network/haqq/types"</span>
	<span class="token string">"github.com/haqq-network/haqq/x/evm/statedb"</span>
	<span class="token string">"github.com/haqq-network/haqq/x/evm/types"</span>
<span class="token punctuation">)</span>

<span class="token comment">// NewEVM generates a go-ethereum VM from the provided Message fields and the chain parameters</span>
<span class="token comment">// (ChainConfig and module Params). It additionally sets the validator operator address as the</span>
<span class="token comment">// coinbase address to make it available for the COINBASE opcode, even though there is no</span>
<span class="token comment">// beneficiary of the coinbase transaction (since we're not mining).</span>
<span class="token comment">//</span>
<span class="token comment">// NOTE: the RANDOM opcode is currently not supported since it requires</span>
<span class="token comment">// RANDAO implementation. See https://github.com/evmos/ethermint/pull/1520#pullrequestreview-1200504697</span>
<span class="token comment">// for more information.</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">NewEVM</span><span class="token punctuation">(</span>
	ctx sdk<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>
	msg core<span class="token punctuation">.</span>Message<span class="token punctuation">,</span>
	cfg <span class="token operator">*</span>statedb<span class="token punctuation">.</span>EVMConfig<span class="token punctuation">,</span>
	tracer vm<span class="token punctuation">.</span>EVMLogger<span class="token punctuation">,</span>
	stateDB vm<span class="token punctuation">.</span>StateDB<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">*</span>vm<span class="token punctuation">.</span>EVM <span class="token punctuation">{</span>
	blockCtx <span class="token operator">:=</span> vm<span class="token punctuation">.</span>BlockContext<span class="token punctuation">{</span>
		CanTransfer<span class="token punctuation">:</span> core<span class="token punctuation">.</span>CanTransfer<span class="token punctuation">,</span>
		Transfer<span class="token punctuation">:</span>    core<span class="token punctuation">.</span>Transfer<span class="token punctuation">,</span>
		GetHash<span class="token punctuation">:</span>     k<span class="token punctuation">.</span><span class="token function">GetHashFn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span>
		Coinbase<span class="token punctuation">:</span>    cfg<span class="token punctuation">.</span>CoinBase<span class="token punctuation">,</span>
		GasLimit<span class="token punctuation">:</span>    haqqtypes<span class="token punctuation">.</span><span class="token function">BlockGasLimit</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span>
		BlockNumber<span class="token punctuation">:</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Time<span class="token punctuation">:</span>        big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Difficulty<span class="token punctuation">:</span>  big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// unused. Only required in PoW context</span>
		BaseFee<span class="token punctuation">:</span>     cfg<span class="token punctuation">.</span>BaseFee<span class="token punctuation">,</span>
		Random<span class="token punctuation">:</span>      <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token comment">// not supported</span>
	<span class="token punctuation">}</span>

	txCtx <span class="token operator">:=</span> core<span class="token punctuation">.</span><span class="token function">NewEVMTxContext</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
	<span class="token keyword">if</span> tracer <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		tracer <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">Tracer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	vmConfig <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">VMConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> tracer<span class="token punctuation">)</span>
	<span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">NewEVM</span><span class="token punctuation">(</span>blockCtx<span class="token punctuation">,</span> txCtx<span class="token punctuation">,</span> stateDB<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> vmConfig<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// GetHashFn implements vm.GetHashFunc for Ethermint. It handles 3 cases:</span>
<span class="token comment">//  1. The requested height matches the current height from context (and thus same epoch number)</span>
<span class="token comment">//  2. The requested height is from an previous height from the same chain epoch</span>
<span class="token comment">//  3. The requested height is from a height greater than the latest one</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">GetHashFn</span><span class="token punctuation">(</span>ctx sdk<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> vm<span class="token punctuation">.</span>GetHashFunc <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>height <span class="token builtin">uint64</span><span class="token punctuation">)</span> common<span class="token punctuation">.</span>Hash <span class="token punctuation">{</span>
		h<span class="token punctuation">,</span> err <span class="token operator">:=</span> haqqtypes<span class="token punctuation">.</span><span class="token function">SafeInt64</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			k<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"failed to cast height to int64"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">switch</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> h<span class="token punctuation">:</span>
			<span class="token comment">// Case 1: The requested height matches the one from the context so we can retrieve the header</span>
			<span class="token comment">// hash directly from the context.</span>
			<span class="token comment">// Note: The headerHash is only set at begin block, it will be nil in case of a query context</span>
			headerHash <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">HeaderHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>headerHash<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>headerHash<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// only recompute the hash if not set (eg: checkTxState)</span>
			contextBlockHeader <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">BlockHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			header<span class="token punctuation">,</span> err <span class="token operator">:=</span> tmtypes<span class="token punctuation">.</span><span class="token function">HeaderFromProto</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>contextBlockHeader<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				k<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"failed to cast tendermint header from proto"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			headerHash <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>headerHash<span class="token punctuation">)</span>

		<span class="token keyword">case</span> ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> h<span class="token punctuation">:</span>
			<span class="token comment">// Case 2: if the chain is not the current height we need to retrieve the hash from the store for the</span>
			<span class="token comment">// current chain epoch. This only applies if the current height is greater than the requested height.</span>
			histInfo<span class="token punctuation">,</span> found <span class="token operator">:=</span> k<span class="token punctuation">.</span>stakingKeeper<span class="token punctuation">.</span><span class="token function">GetHistoricalInfo</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>
				k<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"historical info not found"</span><span class="token punctuation">,</span> <span class="token string">"height"</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span>
				<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			header<span class="token punctuation">,</span> err <span class="token operator">:=</span> tmtypes<span class="token punctuation">.</span><span class="token function">HeaderFromProto</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>histInfo<span class="token punctuation">.</span>Header<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				k<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"failed to cast tendermint header from proto"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">return</span> common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token comment">// Case 3: heights greater than the current one returns an empty hash.</span>
			<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ApplyTransaction runs and attempts to perform a state transition with the given transaction (i.e Message), that will</span>
<span class="token comment">// only be persisted (committed) to the underlying KVStore if the transaction does not fail.</span>
<span class="token comment">//</span>
<span class="token comment">// # Gas tracking</span>
<span class="token comment">//</span>
<span class="token comment">// Ethereum consumes gas according to the EVM opcodes instead of general reads and writes to store. Because of this, the</span>
<span class="token comment">// state transition needs to ignore the SDK gas consumption mechanism defined by the GasKVStore and instead consume the</span>
<span class="token comment">// amount of gas used by the VM execution. The amount of gas used is tracked by the EVM and returned in the execution</span>
<span class="token comment">// result.</span>
<span class="token comment">//</span>
<span class="token comment">// Prior to the execution, the starting tx gas meter is saved and replaced with an infinite gas meter in a new context</span>
<span class="token comment">// in order to ignore the SDK gas consumption config values (read, write, has, delete).</span>
<span class="token comment">// After the execution, the gas used from the message execution will be added to the starting gas consumed, taking into</span>
<span class="token comment">// consideration the amount of gas returned. Finally, the context is updated with the EVM gas consumed value prior to</span>
<span class="token comment">// returning.</span>
<span class="token comment">//</span>
<span class="token comment">// For relevant discussion see: https://github.com/cosmos/cosmos-sdk/discussions/9072</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">ApplyTransaction</span><span class="token punctuation">(</span>ctx sdk<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> tx <span class="token operator">*</span>ethtypes<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>MsgEthereumTxResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		bloom        <span class="token operator">*</span>big<span class="token punctuation">.</span>Int
		bloomReceipt ethtypes<span class="token punctuation">.</span>Bloom
	<span class="token punctuation">)</span>

	cfg<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">EVMConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> sdk<span class="token punctuation">.</span><span class="token function">ConsAddress</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ProposerAddress<span class="token punctuation">)</span><span class="token punctuation">,</span> k<span class="token punctuation">.</span>eip155ChainID<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorsmod<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed to load evm config"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	txConfig <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">TxConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// get the signer according to the chain rules from the config and block height</span>
	signer <span class="token operator">:=</span> ethtypes<span class="token punctuation">.</span><span class="token function">MakeSigner</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	msg<span class="token punctuation">,</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">AsMessage</span><span class="token punctuation">(</span>signer<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>BaseFee<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorsmod<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed to return ethereum transaction as core message"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// snapshot to contain the tx processing and post processing in same scope</span>
	<span class="token keyword">var</span> commit <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	tmpCtx <span class="token operator">:=</span> ctx
	<span class="token keyword">if</span> k<span class="token punctuation">.</span>hooks <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// Create a cache context to revert state when tx hooks fails,</span>
		<span class="token comment">// the cache context is only committed when both tx and hooks executed successfully.</span>
		<span class="token comment">// Didn't use `Snapshot` because the context stack has exponential complexity on certain operations,</span>
		<span class="token comment">// thus restricted to be used only inside `ApplyMessage`.</span>
		tmpCtx<span class="token punctuation">,</span> commit <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">CacheContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// pass true to commit the StateDB</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">ApplyMessageWithConfig</span><span class="token punctuation">(</span>tmpCtx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> txConfig<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorsmod<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed to apply ethereum core message"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	logs <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">LogsToEthereum</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Logs<span class="token punctuation">)</span>

	<span class="token comment">// Compute block bloom filter</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>logs<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
		bloom <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">GetBlockBloomTransient</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
		bloom<span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span>bloom<span class="token punctuation">,</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span>ethtypes<span class="token punctuation">.</span><span class="token function">LogsBloom</span><span class="token punctuation">(</span>logs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		bloomReceipt <span class="token operator">=</span> ethtypes<span class="token punctuation">.</span><span class="token function">BytesToBloom</span><span class="token punctuation">(</span>bloom<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	cumulativeGasUsed <span class="token operator">:=</span> res<span class="token punctuation">.</span>GasUsed
	<span class="token keyword">if</span> ctx<span class="token punctuation">.</span><span class="token function">BlockGasMeter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		limit <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">BlockGasMeter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		cumulativeGasUsed <span class="token operator">+=</span> ctx<span class="token punctuation">.</span><span class="token function">BlockGasMeter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GasConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> cumulativeGasUsed <span class="token operator">></span> limit <span class="token punctuation">{</span>
			cumulativeGasUsed <span class="token operator">=</span> limit
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> contractAddr common<span class="token punctuation">.</span>Address
	<span class="token keyword">if</span> msg<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		contractAddr <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">CreateAddress</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">From</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	receipt <span class="token operator">:=</span> <span class="token operator">&amp;</span>ethtypes<span class="token punctuation">.</span>Receipt<span class="token punctuation">{</span>
		Type<span class="token punctuation">:</span>              tx<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		PostState<span class="token punctuation">:</span>         <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token comment">// TODO: intermediate state root</span>
		CumulativeGasUsed<span class="token punctuation">:</span> cumulativeGasUsed<span class="token punctuation">,</span>
		Bloom<span class="token punctuation">:</span>             bloomReceipt<span class="token punctuation">,</span>
		Logs<span class="token punctuation">:</span>              logs<span class="token punctuation">,</span>
		TxHash<span class="token punctuation">:</span>            txConfig<span class="token punctuation">.</span>TxHash<span class="token punctuation">,</span>
		ContractAddress<span class="token punctuation">:</span>   contractAddr<span class="token punctuation">,</span>
		GasUsed<span class="token punctuation">:</span>           res<span class="token punctuation">.</span>GasUsed<span class="token punctuation">,</span>
		BlockHash<span class="token punctuation">:</span>         txConfig<span class="token punctuation">.</span>BlockHash<span class="token punctuation">,</span>
		BlockNumber<span class="token punctuation">:</span>       big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		TransactionIndex<span class="token punctuation">:</span>  txConfig<span class="token punctuation">.</span>TxIndex<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>res<span class="token punctuation">.</span><span class="token function">Failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		receipt<span class="token punctuation">.</span>Status <span class="token operator">=</span> ethtypes<span class="token punctuation">.</span>ReceiptStatusSuccessful
		<span class="token comment">// Only call hooks if tx executed successfully.</span>
		<span class="token keyword">if</span> err <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">PostTxProcessing</span><span class="token punctuation">(</span>tmpCtx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> receipt<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token comment">// If hooks return error, revert the whole tx.</span>
			res<span class="token punctuation">.</span>VmError <span class="token operator">=</span> types<span class="token punctuation">.</span>ErrPostTxProcessing<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			k<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"tx post processing failed"</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>

			<span class="token comment">// If the tx failed in post processing hooks, we should clear the logs</span>
			res<span class="token punctuation">.</span>Logs <span class="token operator">=</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> commit <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token comment">// PostTxProcessing is successful, commit the tmpCtx</span>
			<span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token comment">// Since the post-processing can alter the log, we need to update the result</span>
			res<span class="token punctuation">.</span>Logs <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">NewLogsFromEth</span><span class="token punctuation">(</span>receipt<span class="token punctuation">.</span>Logs<span class="token punctuation">)</span>
			ctx<span class="token punctuation">.</span><span class="token function">EventManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">EmitEvents</span><span class="token punctuation">(</span>tmpCtx<span class="token punctuation">.</span><span class="token function">EventManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// refund gas in order to match the Ethereum gas consumption instead of the default SDK one.</span>
	<span class="token keyword">if</span> err <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">RefundGas</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>res<span class="token punctuation">.</span>GasUsed<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>Params<span class="token punctuation">.</span>EvmDenom<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorsmod<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed to refund gas leftover gas to sender %s"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">From</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>receipt<span class="token punctuation">.</span>Logs<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token comment">// Update transient block bloom filter</span>
		k<span class="token punctuation">.</span><span class="token function">SetBlockBloomTransient</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> receipt<span class="token punctuation">.</span>Bloom<span class="token punctuation">.</span><span class="token function">Big</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		k<span class="token punctuation">.</span><span class="token function">SetLogSizeTransient</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">uint64</span><span class="token punctuation">(</span>txConfig<span class="token punctuation">.</span>LogIndex<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>receipt<span class="token punctuation">.</span>Logs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	k<span class="token punctuation">.</span><span class="token function">SetTxIndexTransient</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">uint64</span><span class="token punctuation">(</span>txConfig<span class="token punctuation">.</span>TxIndex<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>

	totalGasUsed<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">AddTransientGasUsed</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> res<span class="token punctuation">.</span>GasUsed<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorsmod<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed to add transient gas used"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// reset the gas meter for current cosmos transaction</span>
	k<span class="token punctuation">.</span><span class="token function">ResetGasMeterAndConsumeGas</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> totalGasUsed<span class="token punctuation">)</span>
	<span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// ApplyMessage calls ApplyMessageWithConfig with an empty TxConfig.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">ApplyMessage</span><span class="token punctuation">(</span>ctx sdk<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> msg core<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> tracer vm<span class="token punctuation">.</span>EVMLogger<span class="token punctuation">,</span> commit <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>MsgEthereumTxResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	cfg<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">EVMConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> sdk<span class="token punctuation">.</span><span class="token function">ConsAddress</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ProposerAddress<span class="token punctuation">)</span><span class="token punctuation">,</span> k<span class="token punctuation">.</span>eip155ChainID<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorsmod<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed to load evm config"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	txConfig <span class="token operator">:=</span> statedb<span class="token punctuation">.</span><span class="token function">NewEmptyTxConfig</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">HeaderHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> k<span class="token punctuation">.</span><span class="token function">ApplyMessageWithConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> tracer<span class="token punctuation">,</span> commit<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> txConfig<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// ApplyMessageWithConfig computes the new state by applying the given message against the existing state.</span>
<span class="token comment">// If the message fails, the VM execution error with the reason will be returned to the client</span>
<span class="token comment">// and the transaction won't be committed to the store.</span>
<span class="token comment">//</span>
<span class="token comment">// # Reverted state</span>
<span class="token comment">//</span>
<span class="token comment">// The snapshot and rollback are supported by the `statedb.StateDB`.</span>
<span class="token comment">//</span>
<span class="token comment">// # Different Callers</span>
<span class="token comment">//</span>
<span class="token comment">// It's called in three scenarios:</span>
<span class="token comment">// 1. `ApplyTransaction`, in the transaction processing flow.</span>
<span class="token comment">// 2. `EthCall/EthEstimateGas` grpc query handler.</span>
<span class="token comment">// 3. Called by other native modules directly.</span>
<span class="token comment">//</span>
<span class="token comment">// # Prechecks and Preprocessing</span>
<span class="token comment">//</span>
<span class="token comment">// All relevant state transition prechecks for the MsgEthereumTx are performed on the AnteHandler,</span>
<span class="token comment">// prior to running the transaction against the state. The prechecks run are the following:</span>
<span class="token comment">//</span>
<span class="token comment">// 1. the nonce of the message caller is correct</span>
<span class="token comment">// 2. caller has enough balance to cover transaction fee(gaslimit * gasprice)</span>
<span class="token comment">// 3. the amount of gas required is available in the block</span>
<span class="token comment">// 4. the purchased gas is enough to cover intrinsic usage</span>
<span class="token comment">// 5. there is no overflow when calculating intrinsic gas</span>
<span class="token comment">// 6. caller has enough balance to cover asset transfer for **topmost** call</span>
<span class="token comment">//</span>
<span class="token comment">// The preprocessing steps performed by the AnteHandler are:</span>
<span class="token comment">//</span>
<span class="token comment">// 1. set up the initial access list (iff fork > Berlin)</span>
<span class="token comment">//</span>
<span class="token comment">// # Tracer parameter</span>
<span class="token comment">//</span>
<span class="token comment">// It should be a `vm.Tracer` object or nil, if pass `nil`, it'll create a default one based on keeper options.</span>
<span class="token comment">//</span>
<span class="token comment">// # Commit parameter</span>
<span class="token comment">//</span>
<span class="token comment">// If commit is true, the `StateDB` will be committed, otherwise discarded.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">ApplyMessageWithConfig</span><span class="token punctuation">(</span>ctx sdk<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>
	msg core<span class="token punctuation">.</span>Message<span class="token punctuation">,</span>
	tracer vm<span class="token punctuation">.</span>EVMLogger<span class="token punctuation">,</span>
	commit <span class="token builtin">bool</span><span class="token punctuation">,</span>
	cfg <span class="token operator">*</span>statedb<span class="token punctuation">.</span>EVMConfig<span class="token punctuation">,</span>
	txConfig statedb<span class="token punctuation">.</span>TxConfig<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>MsgEthereumTxResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		ret   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token comment">// return bytes from evm execution</span>
		vmErr <span class="token builtin">error</span>  <span class="token comment">// vm errors do not effect consensus and are therefore not assigned to err</span>
	<span class="token punctuation">)</span>

	<span class="token comment">// return error if contract creation or call are disabled through governance</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>cfg<span class="token punctuation">.</span>Params<span class="token punctuation">.</span>EnableCreate <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorsmod<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>ErrCreateDisabled<span class="token punctuation">,</span> <span class="token string">"failed to create new contract"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token operator">!</span>cfg<span class="token punctuation">.</span>Params<span class="token punctuation">.</span>EnableCall <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorsmod<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>ErrCallDisabled<span class="token punctuation">,</span> <span class="token string">"failed to call contract"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	stateDB <span class="token operator">:=</span> statedb<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> k<span class="token punctuation">,</span> txConfig<span class="token punctuation">)</span>
	evm <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">NewEVM</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> tracer<span class="token punctuation">,</span> stateDB<span class="token punctuation">)</span>

	leftoverGas <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Allow the tracer captures the tx level events, mainly the gas consumption.</span>
	vmCfg <span class="token operator">:=</span> evm<span class="token punctuation">.</span>Config
	<span class="token keyword">if</span> vmCfg<span class="token punctuation">.</span>Debug <span class="token punctuation">{</span>
		vmCfg<span class="token punctuation">.</span>Tracer<span class="token punctuation">.</span><span class="token function">CaptureTxStart</span><span class="token punctuation">(</span>leftoverGas<span class="token punctuation">)</span>
		<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			vmCfg<span class="token punctuation">.</span>Tracer<span class="token punctuation">.</span><span class="token function">CaptureTxEnd</span><span class="token punctuation">(</span>leftoverGas<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	sender <span class="token operator">:=</span> vm<span class="token punctuation">.</span><span class="token function">AccountRef</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">From</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	contractCreation <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span>
	isLondon <span class="token operator">:=</span> cfg<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">.</span><span class="token function">IsLondon</span><span class="token punctuation">(</span>evm<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>BlockNumber<span class="token punctuation">)</span>

	intrinsicGas<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetEthIntrinsicGas</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> contractCreation<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// should have already been checked on Ante Handler</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorsmod<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"intrinsic gas failed"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Should check again even if it is checked on Ante Handler, because eth_call don't go through Ante Handler.</span>
	<span class="token keyword">if</span> leftoverGas <span class="token operator">&lt;</span> intrinsicGas <span class="token punctuation">{</span>
		<span class="token comment">// eth_estimateGas will check for this exact error</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorsmod<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>core<span class="token punctuation">.</span>ErrIntrinsicGas<span class="token punctuation">,</span> <span class="token string">"apply message"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	leftoverGas <span class="token operator">-=</span> intrinsicGas

	<span class="token comment">// access list preparation is moved from ante handler to here, because it's needed when `ApplyMessage` is called</span>
	<span class="token comment">// under contexts where ante handlers are not run, for example `eth_call` and `eth_estimateGas`.</span>
	<span class="token keyword">if</span> rules <span class="token operator">:=</span> cfg<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">.</span><span class="token function">Rules</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">.</span>MergeNetsplitBlock <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rules<span class="token punctuation">.</span>IsBerlin <span class="token punctuation">{</span>
		stateDB<span class="token punctuation">.</span><span class="token function">PrepareAccessList</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">From</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vm<span class="token punctuation">.</span><span class="token function">ActivePrecompiles</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">AccessList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> contractCreation <span class="token punctuation">{</span>
		<span class="token comment">// take over the nonce management from evm:</span>
		<span class="token comment">// - reset sender's nonce to msg.Nonce() before calling evm.</span>
		<span class="token comment">// - increase sender's nonce by one no matter the result.</span>
		stateDB<span class="token punctuation">.</span><span class="token function">SetNonce</span><span class="token punctuation">(</span>sender<span class="token punctuation">.</span><span class="token function">Address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		ret<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> vmErr <span class="token operator">=</span> evm<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		stateDB<span class="token punctuation">.</span><span class="token function">SetNonce</span><span class="token punctuation">(</span>sender<span class="token punctuation">.</span><span class="token function">Address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		ret<span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> vmErr <span class="token operator">=</span> evm<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> <span class="token operator">*</span>msg<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	refundQuotient <span class="token operator">:=</span> params<span class="token punctuation">.</span>RefundQuotient

	<span class="token comment">// After EIP-3529: refunds are capped to gasUsed / 5</span>
	<span class="token keyword">if</span> isLondon <span class="token punctuation">{</span>
		refundQuotient <span class="token operator">=</span> params<span class="token punctuation">.</span>RefundQuotientEIP3529
	<span class="token punctuation">}</span>

	<span class="token comment">// calculate gas refund</span>
	<span class="token keyword">if</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> leftoverGas <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorsmod<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>ErrGasOverflow<span class="token punctuation">,</span> <span class="token string">"apply message"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// refund gas</span>
	temporaryGasUsed <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> leftoverGas
	refund <span class="token operator">:=</span> <span class="token function">GasToRefund</span><span class="token punctuation">(</span>stateDB<span class="token punctuation">.</span><span class="token function">GetRefund</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> temporaryGasUsed<span class="token punctuation">,</span> refundQuotient<span class="token punctuation">)</span>

	<span class="token comment">// update leftoverGas and temporaryGasUsed with refund amount</span>
	leftoverGas <span class="token operator">+=</span> refund
	temporaryGasUsed <span class="token operator">-=</span> refund

	<span class="token comment">// EVM execution error needs to be available for the JSON-RPC client</span>
	<span class="token keyword">var</span> vmError <span class="token builtin">string</span>
	<span class="token keyword">if</span> vmErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		vmError <span class="token operator">=</span> vmErr<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// The dirty states in `StateDB` is either committed or discarded after return</span>
	<span class="token keyword">if</span> commit <span class="token punctuation">{</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> stateDB<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorsmod<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"failed to commit stateDB"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// calculate a minimum amount of gas to be charged to sender if GasLimit</span>
	<span class="token comment">// is considerably higher than GasUsed to stay more aligned with Tendermint gas mechanics</span>
	<span class="token comment">// for more info https://github.com/evmos/ethermint/issues/1085</span>
	gasLimit <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">NewDec</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	minGasMultiplier <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetMinGasMultiplier</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	minimumGasUsed <span class="token operator">:=</span> gasLimit<span class="token punctuation">.</span><span class="token function">Mul</span><span class="token punctuation">(</span>minGasMultiplier<span class="token punctuation">)</span>

	<span class="token keyword">if</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> leftoverGas <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorsmod<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>ErrGasOverflow<span class="token punctuation">,</span> <span class="token string">"message gas limit &lt; leftover gas (%d &lt; %d)"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> leftoverGas<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	gasUsed <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">MaxDec</span><span class="token punctuation">(</span>minimumGasUsed<span class="token punctuation">,</span> sdk<span class="token punctuation">.</span><span class="token function">NewDec</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span>temporaryGasUsed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">TruncateInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// reset leftoverGas, to be used by the tracer</span>
	leftoverGas <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> gasUsed

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>MsgEthereumTxResponse<span class="token punctuation">{</span>
		GasUsed<span class="token punctuation">:</span> gasUsed<span class="token punctuation">,</span>
		VmError<span class="token punctuation">:</span> vmError<span class="token punctuation">,</span>
		Ret<span class="token punctuation">:</span>     ret<span class="token punctuation">,</span>
		Logs<span class="token punctuation">:</span>    types<span class="token punctuation">.</span><span class="token function">NewLogsFromEth</span><span class="token punctuation">(</span>stateDB<span class="token punctuation">.</span><span class="token function">Logs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Hash<span class="token punctuation">:</span>    txConfig<span class="token punctuation">.</span>TxHash<span class="token punctuation">.</span><span class="token function">Hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</span></span></span></span> <!----></span> <!----></span></span></p> <h3 id="antehandler"><a href="#antehandler" class="header-anchor">#</a> <code>AnteHandler</code></h3> <p>The Cosmos SDK <a href="https://docs.cosmos.network/master/basics/gas-fees.html#antehandler" target="_blank" rel="noopener noreferrer"><code>AnteHandler</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
performs basic checks prior to transaction execution. These checks are usually signature
verification, transaction field validation, transaction fees, etc.</p> <p>Regarding gas consumption and fees, the <code>AnteHandler</code> checks that the user has enough balance to
cover for the tx cost (amount plus fees) as well as checking that the gas limit defined in the
message is greater or equal than the computed intrinsic gas for the message.</p> <h2 id="gas-refunds"><a href="#gas-refunds" class="header-anchor">#</a> Gas Refunds</h2> <p>In the EVM, gas can be specified prior to execution. The totality of the gas specified is consumed at the beginning of the execution (during the <code>AnteHandler</code> step) and the remaining gas is refunded back to
the user if any gas is left over after the execution. Additionally the EVM can also define gas to be refunded back to the user but those will be capped to a fraction of the used gas depending on the fork/version being used.</p> <h2 id="_0-fee-transactions"><a href="#_0-fee-transactions" class="header-anchor">#</a> 0 Fee Transactions</h2> <p>In Cosmos, a minimum gas price is not enforced by the <code>AnteHandler</code> as the <code>min-gas-prices</code> is
checked against the local node/validator. In other words, the minimum fees accepted are determined
by the validators of the network, and each validator can specify a different minimum value for their fees.
This potentially allows end users to submit 0 fee transactions if there is at least one single
validator that is willing to include transactions with <code>0</code> gas price in their blocks proposed.</p> <p>For this same reason, in Haqq it is possible to send transactions with <code>0</code> fees for transaction
types other than the ones defined by the <code>evm</code> module. EVM module transactions cannot have <code>0</code> fees
as gas is required inherently by the EVM. This check is done by the EVM transactions stateless validation
(i.e <code>ValidateBasic</code>) function as well as on the custom <code>AnteHandler</code> defined by Haqq.</p> <h2 id="gas-estimation"><a href="#gas-estimation" class="header-anchor">#</a> Gas estimation</h2> <p>Ethereum provides a JSON-RPC endpoint <code>eth_estimateGas</code> to help users set up a correct gas limit in their transactions.</p> <p>Unfortunately, we cannot make use of the SDK <code>tx simulation</code> for gas estimation because the pre-check in the Ante Handlers would require a valid signature, and the sender balance to be enough to pay for the gas. But in Ethereum, this endpoint can be called without specifying any sender address.</p> <p>For that reason, a specific query API <code>EstimateGas</code> is implemented in Haqq. It will apply the transaction against the current block/state and perform a binary search in order to find the optimal gas value to return to the user (the same transaction will be applied over and over until we find the minimum gas needed before it fails). The reason we need to use a binary search is that the gas required for the
transaction might be higher than the value returned by the EVM after applying the transaction, so we need to try until we find the optimal value.</p> <p>A cache context will be used during the whole execution to avoid changes be persisted in the state.</p> <p><span class="codeblock" data-v-1eda75b2><span class="container codeblock__hasfooter__false codeblock__is-expandable__false codeblock__expanded__false" data-v-1eda75b2><span class="body__container" data-v-1eda75b2><span class="body__block" data-v-1eda75b2><span class="icons" data-v-1eda75b2><!----> <span class="icons__item" data-v-1eda75b2><svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="icons__item__icon" data-v-1eda75b2><path fill-rule="evenodd" clip-rule="evenodd" d="M11 0.25C10.0335 0.25 9.25 1.0335 9.25 2V4.5H10.75V2C10.75 1.86193 10.8619 1.75 11 1.75H21C21.1381 1.75 21.25 1.86193 21.25 2V16C21.25 16.1381 21.1381 16.25 21 16.25H16.5V17.75H21C21.9665 17.75 22.75 16.9665 22.75 16V2C22.75 1.0335 21.9665 0.25 21 0.25H11ZM3 6.25C2.0335 6.25 1.25 7.0335 1.25 8V22C1.25 22.9665 2.0335 23.75 3 23.75H13C13.9665 23.75 14.75 22.9665 14.75 22V8C14.75 7.0335 13.9665 6.25 13 6.25H3ZM2.75 8C2.75 7.86193 2.86193 7.75 3 7.75H13C13.1381 7.75 13.25 7.86193 13.25 8V22C13.25 22.1381 13.1381 22.25 13 22.25H3C2.86193 22.25 2.75 22.1381 2.75 22V8Z" data-v-1eda75b2></path></svg> <span class="icons__item__tooltip" data-v-1eda75b2>
              Copy
            </span></span></span> <span class="body" data-v-1eda75b2><span class="body__wrapper" data-v-1eda75b2><span class="body__code" data-v-1eda75b2><span class="token keyword">package</span> keeper

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"encoding/json"</span>
	<span class="token string">"errors"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"math/big"</span>
	<span class="token string">"time"</span>

	<span class="token string">"google.golang.org/grpc/codes"</span>
	<span class="token string">"google.golang.org/grpc/status"</span>

	sdkmath <span class="token string">"cosmossdk.io/math"</span>
	sdk <span class="token string">"github.com/cosmos/cosmos-sdk/types"</span>
	<span class="token string">"github.com/ethereum/go-ethereum/common"</span>
	<span class="token string">"github.com/ethereum/go-ethereum/common/hexutil"</span>
	<span class="token string">"github.com/ethereum/go-ethereum/core"</span>
	ethtypes <span class="token string">"github.com/ethereum/go-ethereum/core/types"</span>
	<span class="token string">"github.com/ethereum/go-ethereum/core/vm"</span>
	<span class="token string">"github.com/ethereum/go-ethereum/eth/tracers"</span>
	<span class="token string">"github.com/ethereum/go-ethereum/eth/tracers/logger"</span>
	ethparams <span class="token string">"github.com/ethereum/go-ethereum/params"</span>

	haqqtypes <span class="token string">"github.com/haqq-network/haqq/types"</span>
	<span class="token string">"github.com/haqq-network/haqq/x/evm/statedb"</span>
	<span class="token string">"github.com/haqq-network/haqq/x/evm/types"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token boolean">_</span> types<span class="token punctuation">.</span>QueryServer <span class="token operator">=</span> Keeper<span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	defaultTraceTimeout <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second
<span class="token punctuation">)</span>

<span class="token comment">// Account implements the Query/Account gRPC method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">Account</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryAccountRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryAccountResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"empty request"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> haqqtypes<span class="token punctuation">.</span><span class="token function">ValidateAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>
			codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	addr <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">HexToAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span>

	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	acct <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetAccountOrEmpty</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryAccountResponse<span class="token punctuation">{</span>
		Balance<span class="token punctuation">:</span>  acct<span class="token punctuation">.</span>Balance<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		CodeHash<span class="token punctuation">:</span> common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>acct<span class="token punctuation">.</span>CodeHash<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Nonce<span class="token punctuation">:</span>    acct<span class="token punctuation">.</span>Nonce<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">CosmosAccount</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryCosmosAccountRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryCosmosAccountResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"empty request"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> haqqtypes<span class="token punctuation">.</span><span class="token function">ValidateAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>
			codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

	ethAddr <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">HexToAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span>
	cosmosAddr <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">AccAddress</span><span class="token punctuation">(</span>ethAddr<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	account <span class="token operator">:=</span> k<span class="token punctuation">.</span>accountKeeper<span class="token punctuation">.</span><span class="token function">GetAccount</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cosmosAddr<span class="token punctuation">)</span>
	res <span class="token operator">:=</span> types<span class="token punctuation">.</span>QueryCosmosAccountResponse<span class="token punctuation">{</span>
		CosmosAddress<span class="token punctuation">:</span> cosmosAddr<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> account <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span>Sequence <span class="token operator">=</span> account<span class="token punctuation">.</span><span class="token function">GetSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		res<span class="token punctuation">.</span>AccountNumber <span class="token operator">=</span> account<span class="token punctuation">.</span><span class="token function">GetAccountNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// ValidatorAccount implements the Query/Balance gRPC method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">ValidatorAccount</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryValidatorAccountRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryValidatorAccountResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"empty request"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	consAddr<span class="token punctuation">,</span> err <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">ConsAddressFromBech32</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>ConsAddress<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>
			codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

	validator<span class="token punctuation">,</span> found <span class="token operator">:=</span> k<span class="token punctuation">.</span>stakingKeeper<span class="token punctuation">.</span><span class="token function">GetValidatorByConsAddr</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> consAddr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"validator not found for %s"</span><span class="token punctuation">,</span> consAddr<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	accAddr <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">AccAddress</span><span class="token punctuation">(</span>validator<span class="token punctuation">.</span><span class="token function">GetOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	res <span class="token operator">:=</span> types<span class="token punctuation">.</span>QueryValidatorAccountResponse<span class="token punctuation">{</span>
		AccountAddress<span class="token punctuation">:</span> accAddr<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	account <span class="token operator">:=</span> k<span class="token punctuation">.</span>accountKeeper<span class="token punctuation">.</span><span class="token function">GetAccount</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> accAddr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> account <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span>Sequence <span class="token operator">=</span> account<span class="token punctuation">.</span><span class="token function">GetSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		res<span class="token punctuation">.</span>AccountNumber <span class="token operator">=</span> account<span class="token punctuation">.</span><span class="token function">GetAccountNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// Balance implements the Query/Balance gRPC method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">Balance</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryBalanceRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryBalanceResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"empty request"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> haqqtypes<span class="token punctuation">.</span><span class="token function">ValidateAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>
			codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span>
			types<span class="token punctuation">.</span>ErrZeroAddress<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

	balanceInt <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetBalance</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> common<span class="token punctuation">.</span><span class="token function">HexToAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryBalanceResponse<span class="token punctuation">{</span>
		Balance<span class="token punctuation">:</span> balanceInt<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// Storage implements the Query/Storage gRPC method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">Storage</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryStorageRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryStorageResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"empty request"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> haqqtypes<span class="token punctuation">.</span><span class="token function">ValidateAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>
			codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span>
			types<span class="token punctuation">.</span>ErrZeroAddress<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

	address <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">HexToAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span>
	key <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">HexToHash</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>

	state <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> address<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	stateHex <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">Hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryStorageResponse<span class="token punctuation">{</span>
		Value<span class="token punctuation">:</span> stateHex<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// Code implements the Query/Code gRPC method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">Code</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryCodeRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryCodeResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"empty request"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> haqqtypes<span class="token punctuation">.</span><span class="token function">ValidateAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>
			codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span>
			types<span class="token punctuation">.</span>ErrZeroAddress<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

	address <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">HexToAddress</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Address<span class="token punctuation">)</span>
	acct <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetAccountWithoutBalance</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> address<span class="token punctuation">)</span>

	<span class="token keyword">var</span> code <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
	<span class="token keyword">if</span> acct <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> acct<span class="token punctuation">.</span><span class="token function">IsContract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		code <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">GetCode</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>acct<span class="token punctuation">.</span>CodeHash<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryCodeResponse<span class="token punctuation">{</span>
		Code<span class="token punctuation">:</span> code<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// Params implements the Query/Params gRPC method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">Params</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryParamsRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryParamsResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	params <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetParams</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryParamsResponse<span class="token punctuation">{</span>
		Params<span class="token punctuation">:</span> params<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// EthCall implements eth_call rpc api.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">EthCall</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>EthCallRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>MsgEthereumTxResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"empty request"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

	<span class="token keyword">var</span> args types<span class="token punctuation">.</span>TransactionArgs
	err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	chainID<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getChainID</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>ChainId<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	cfg<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">EVMConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">GetProposerAddress</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>ProposerAddress<span class="token punctuation">)</span><span class="token punctuation">,</span> chainID<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// ApplyMessageWithConfig expect correct nonce set in msg</span>
	nonce <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetNonce</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">GetFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	args<span class="token punctuation">.</span>Nonce <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>hexutil<span class="token punctuation">.</span>Uint64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nonce<span class="token punctuation">)</span>

	msg<span class="token punctuation">,</span> err <span class="token operator">:=</span> args<span class="token punctuation">.</span><span class="token function">ToMessage</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>GasCap<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>BaseFee<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	txConfig <span class="token operator">:=</span> statedb<span class="token punctuation">.</span><span class="token function">NewEmptyTxConfig</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">HeaderHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// pass false to not commit StateDB</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">ApplyMessageWithConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> txConfig<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// EstimateGas implements eth_estimateGas rpc api.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">EstimateGas</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>EthCallRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>EstimateGasResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"empty request"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	chainID<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getChainID</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>ChainId<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> req<span class="token punctuation">.</span>GasCap <span class="token operator">&lt;</span> ethparams<span class="token punctuation">.</span>TxGas <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"gas cap cannot be lower than 21,000"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> args types<span class="token punctuation">.</span>TransactionArgs
	err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Binary search the gas requirement, as it may be higher than the amount used</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		lo     <span class="token operator">=</span> ethparams<span class="token punctuation">.</span>TxGas <span class="token operator">-</span> <span class="token number">1</span>
		hi     <span class="token builtin">uint64</span>
		gasCap <span class="token builtin">uint64</span>
	<span class="token punctuation">)</span>

	<span class="token comment">// Determine the highest gas limit can be used during the estimation.</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>Gas <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">.</span>Gas<span class="token punctuation">)</span> <span class="token operator">>=</span> ethparams<span class="token punctuation">.</span>TxGas <span class="token punctuation">{</span>
		hi <span class="token operator">=</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">.</span>Gas<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// Query block gas limit</span>
		params <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">ConsensusParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> params <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> params<span class="token punctuation">.</span>Block <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> params<span class="token punctuation">.</span>Block<span class="token punctuation">.</span>MaxGas <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
			hi <span class="token operator">=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>Block<span class="token punctuation">.</span>MaxGas<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			hi <span class="token operator">=</span> req<span class="token punctuation">.</span>GasCap
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// TODO: Recap the highest gas limit with account's available balance.</span>

	<span class="token comment">// Recap the highest gas allowance with specified gascap.</span>
	<span class="token keyword">if</span> req<span class="token punctuation">.</span>GasCap <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> hi <span class="token operator">></span> req<span class="token punctuation">.</span>GasCap <span class="token punctuation">{</span>
		hi <span class="token operator">=</span> req<span class="token punctuation">.</span>GasCap
	<span class="token punctuation">}</span>

	gasCap <span class="token operator">=</span> hi
	cfg<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">EVMConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">GetProposerAddress</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>ProposerAddress<span class="token punctuation">)</span><span class="token punctuation">,</span> chainID<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> <span class="token string">"failed to load evm config"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// ApplyMessageWithConfig expect correct nonce set in msg</span>
	nonce <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetNonce</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">GetFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	args<span class="token punctuation">.</span>Nonce <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>hexutil<span class="token punctuation">.</span>Uint64<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nonce<span class="token punctuation">)</span>

	txConfig <span class="token operator">:=</span> statedb<span class="token punctuation">.</span><span class="token function">NewEmptyTxConfig</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">HeaderHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// convert the tx args to an ethereum message</span>
	msg<span class="token punctuation">,</span> err <span class="token operator">:=</span> args<span class="token punctuation">.</span><span class="token function">ToMessage</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>GasCap<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>BaseFee<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// NOTE: the errors from the executable below should be consistent with go-ethereum,</span>
	<span class="token comment">// so we don't wrap them with the gRPC status code</span>

	<span class="token comment">// Create a helper to check if a gas allowance results in an executable transaction</span>
	executable <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>gas <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>vmError <span class="token builtin">bool</span><span class="token punctuation">,</span> rsp <span class="token operator">*</span>types<span class="token punctuation">.</span>MsgEthereumTxResponse<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// update the message with the new gas value</span>
		msg <span class="token operator">=</span> ethtypes<span class="token punctuation">.</span><span class="token function">NewMessage</span><span class="token punctuation">(</span>
			msg<span class="token punctuation">.</span><span class="token function">From</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			msg<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			msg<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			msg<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			gas<span class="token punctuation">,</span>
			msg<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			msg<span class="token punctuation">.</span><span class="token function">GasFeeCap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			msg<span class="token punctuation">.</span><span class="token function">GasTipCap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			msg<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			msg<span class="token punctuation">.</span><span class="token function">AccessList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			msg<span class="token punctuation">.</span><span class="token function">IsFake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>

		<span class="token comment">// pass false to not commit StateDB</span>
		rsp<span class="token punctuation">,</span> err <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">ApplyMessageWithConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> txConfig<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> core<span class="token punctuation">.</span>ErrIntrinsicGas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span> <span class="token comment">// Special case, raise gas limit</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err <span class="token comment">// Bail out</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>rsp<span class="token punctuation">.</span>VmError<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> rsp<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Execute the binary search and hone in on an executable gas limit</span>
	hi<span class="token punctuation">,</span> err <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">BinSearch</span><span class="token punctuation">(</span>lo<span class="token punctuation">,</span> hi<span class="token punctuation">,</span> executable<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token comment">// Reject the transaction as invalid if it still fails at the highest allowance</span>
	<span class="token keyword">if</span> hi <span class="token operator">==</span> gasCap <span class="token punctuation">{</span>
		failed<span class="token punctuation">,</span> result<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">executable</span><span class="token punctuation">(</span>hi<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> failed <span class="token punctuation">{</span>
			<span class="token keyword">if</span> result <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>VmError <span class="token operator">!=</span> vm<span class="token punctuation">.</span>ErrOutOfGas<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> result<span class="token punctuation">.</span>VmError <span class="token operator">==</span> vm<span class="token punctuation">.</span>ErrExecutionReverted<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span><span class="token function">NewExecErrorWithReason</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>Ret<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>VmError<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// Otherwise, the specified gas cap is too low</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"gas required exceeds allowance (%d)"</span><span class="token punctuation">,</span> gasCap<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>EstimateGasResponse<span class="token punctuation">{</span>Gas<span class="token punctuation">:</span> hi<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// TraceTx configures a new tracer according to the provided configuration, and</span>
<span class="token comment">// executes the given message in the provided environment. The return value will</span>
<span class="token comment">// be tracer dependent.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">TraceTx</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryTraceTxRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryTraceTxResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"empty request"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> req<span class="token punctuation">.</span>TraceConfig <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>TraceConfig<span class="token punctuation">.</span>Limit <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"output limit cannot be negative, got %d"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>TraceConfig<span class="token punctuation">.</span>Limit<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// minus one to get the context of block beginning</span>
	contextHeight <span class="token operator">:=</span> req<span class="token punctuation">.</span>BlockNumber <span class="token operator">-</span> <span class="token number">1</span>
	<span class="token keyword">if</span> contextHeight <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token comment">// 0 is a special value in `ContextWithHeight`</span>
		contextHeight <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token punctuation">}</span>

	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	ctx <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">WithBlockHeight</span><span class="token punctuation">(</span>contextHeight<span class="token punctuation">)</span>
	ctx <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">WithBlockTime</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>BlockTime<span class="token punctuation">)</span>
	ctx <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">WithHeaderHash</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span><span class="token function">Hex2Bytes</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>BlockHash<span class="token punctuation">)</span><span class="token punctuation">)</span>
	chainID<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getChainID</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>ChainId<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	cfg<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">EVMConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">GetProposerAddress</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>ProposerAddress<span class="token punctuation">)</span><span class="token punctuation">,</span> chainID<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> <span class="token string">"failed to load evm config: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	signer <span class="token operator">:=</span> ethtypes<span class="token punctuation">.</span><span class="token function">MakeSigner</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	txConfig <span class="token operator">:=</span> statedb<span class="token punctuation">.</span><span class="token function">NewEmptyTxConfig</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">HeaderHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> req<span class="token punctuation">.</span>Predecessors <span class="token punctuation">{</span>
		ethTx <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">AsTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		msg<span class="token punctuation">,</span> err <span class="token operator">:=</span> ethTx<span class="token punctuation">.</span><span class="token function">AsMessage</span><span class="token punctuation">(</span>signer<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>BaseFee<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		txConfig<span class="token punctuation">.</span>TxHash <span class="token operator">=</span> ethTx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		txConfig<span class="token punctuation">.</span>TxIndex <span class="token operator">=</span> <span class="token function">uint</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
		rsp<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">ApplyMessageWithConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> types<span class="token punctuation">.</span><span class="token function">NewNoOpTracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> txConfig<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		txConfig<span class="token punctuation">.</span>LogIndex <span class="token operator">+=</span> <span class="token function">uint</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>rsp<span class="token punctuation">.</span>Logs<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	tx <span class="token operator">:=</span> req<span class="token punctuation">.</span>Msg<span class="token punctuation">.</span><span class="token function">AsTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	txConfig<span class="token punctuation">.</span>TxHash <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Predecessors<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
		txConfig<span class="token punctuation">.</span>TxIndex<span class="token operator">++</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> tracerConfig json<span class="token punctuation">.</span>RawMessage
	<span class="token keyword">if</span> req<span class="token punctuation">.</span>TraceConfig <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>TraceConfig<span class="token punctuation">.</span>TracerJsonConfig <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		<span class="token comment">// ignore error. default to no traceConfig</span>
		<span class="token boolean">_</span> <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>TraceConfig<span class="token punctuation">.</span>TracerJsonConfig<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tracerConfig<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	result<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">traceTx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> txConfig<span class="token punctuation">,</span> signer<span class="token punctuation">,</span> tx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>TraceConfig<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> tracerConfig<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// error will be returned with detail status from traceTx</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	resultData<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryTraceTxResponse<span class="token punctuation">{</span>
		Data<span class="token punctuation">:</span> resultData<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// TraceBlock configures a new tracer according to the provided configuration, and</span>
<span class="token comment">// executes the given message in the provided environment for all the transactions in the queried block.</span>
<span class="token comment">// The return value will be tracer dependent.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">TraceBlock</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryTraceBlockRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryTraceBlockResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"empty request"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> req<span class="token punctuation">.</span>TraceConfig <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>TraceConfig<span class="token punctuation">.</span>Limit <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"output limit cannot be negative, got %d"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>TraceConfig<span class="token punctuation">.</span>Limit<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// minus one to get the context of block beginning</span>
	contextHeight <span class="token operator">:=</span> req<span class="token punctuation">.</span>BlockNumber <span class="token operator">-</span> <span class="token number">1</span>
	<span class="token keyword">if</span> contextHeight <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token comment">// 0 is a special value in `ContextWithHeight`</span>
		contextHeight <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token punctuation">}</span>

	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	ctx <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">WithBlockHeight</span><span class="token punctuation">(</span>contextHeight<span class="token punctuation">)</span>
	ctx <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">WithBlockTime</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>BlockTime<span class="token punctuation">)</span>
	ctx <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">WithHeaderHash</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span><span class="token function">Hex2Bytes</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>BlockHash<span class="token punctuation">)</span><span class="token punctuation">)</span>
	chainID<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getChainID</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>ChainId<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	cfg<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">EVMConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">GetProposerAddress</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>ProposerAddress<span class="token punctuation">)</span><span class="token punctuation">,</span> chainID<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> <span class="token string">"failed to load evm config"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	signer <span class="token operator">:=</span> ethtypes<span class="token punctuation">.</span><span class="token function">MakeSigner</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">BlockHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	txsLength <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Txs<span class="token punctuation">)</span>
	results <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>TxTraceResult<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> txsLength<span class="token punctuation">)</span>

	txConfig <span class="token operator">:=</span> statedb<span class="token punctuation">.</span><span class="token function">NewEmptyTxConfig</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">HeaderHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> req<span class="token punctuation">.</span>Txs <span class="token punctuation">{</span>
		result <span class="token operator">:=</span> types<span class="token punctuation">.</span>TxTraceResult<span class="token punctuation">{</span><span class="token punctuation">}</span>
		ethTx <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">AsTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		txConfig<span class="token punctuation">.</span>TxHash <span class="token operator">=</span> ethTx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		txConfig<span class="token punctuation">.</span>TxIndex <span class="token operator">=</span> <span class="token function">uint</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
		traceResult<span class="token punctuation">,</span> logIndex<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">traceTx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> txConfig<span class="token punctuation">,</span> signer<span class="token punctuation">,</span> ethTx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>TraceConfig<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			result<span class="token punctuation">.</span>Error <span class="token operator">=</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			txConfig<span class="token punctuation">.</span>LogIndex <span class="token operator">=</span> logIndex
			result<span class="token punctuation">.</span>Result <span class="token operator">=</span> traceResult
		<span class="token punctuation">}</span>
		results <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>results<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	resultData<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryTraceBlockResponse<span class="token punctuation">{</span>
		Data<span class="token punctuation">:</span> resultData<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// traceTx do trace on one transaction, it returns a tuple: (traceResult, nextLogIndex, error).</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k <span class="token operator">*</span>Keeper<span class="token punctuation">)</span> <span class="token function">traceTx</span><span class="token punctuation">(</span>
	ctx sdk<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>
	cfg <span class="token operator">*</span>statedb<span class="token punctuation">.</span>EVMConfig<span class="token punctuation">,</span>
	txConfig statedb<span class="token punctuation">.</span>TxConfig<span class="token punctuation">,</span>
	signer ethtypes<span class="token punctuation">.</span>Signer<span class="token punctuation">,</span>
	tx <span class="token operator">*</span>ethtypes<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span>
	traceConfig <span class="token operator">*</span>types<span class="token punctuation">.</span>TraceConfig<span class="token punctuation">,</span>
	commitMessage <span class="token builtin">bool</span><span class="token punctuation">,</span>
	tracerJSONConfig json<span class="token punctuation">.</span>RawMessage<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">uint</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Assemble the structured logger or the JavaScript tracer</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		tracer    tracers<span class="token punctuation">.</span>Tracer
		overrides <span class="token operator">*</span>ethparams<span class="token punctuation">.</span>ChainConfig
		err       <span class="token builtin">error</span>
		timeout   <span class="token operator">=</span> defaultTraceTimeout
	<span class="token punctuation">)</span>
	msg<span class="token punctuation">,</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">AsMessage</span><span class="token punctuation">(</span>signer<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>BaseFee<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> traceConfig <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		traceConfig <span class="token operator">=</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>TraceConfig<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> traceConfig<span class="token punctuation">.</span>Overrides <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		overrides <span class="token operator">=</span> traceConfig<span class="token punctuation">.</span>Overrides<span class="token punctuation">.</span><span class="token function">EthereumConfig</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">.</span>ChainID<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	logConfig <span class="token operator">:=</span> logger<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
		EnableMemory<span class="token punctuation">:</span>     traceConfig<span class="token punctuation">.</span>EnableMemory<span class="token punctuation">,</span>
		DisableStorage<span class="token punctuation">:</span>   traceConfig<span class="token punctuation">.</span>DisableStorage<span class="token punctuation">,</span>
		DisableStack<span class="token punctuation">:</span>     traceConfig<span class="token punctuation">.</span>DisableStack<span class="token punctuation">,</span>
		EnableReturnData<span class="token punctuation">:</span> traceConfig<span class="token punctuation">.</span>EnableReturnData<span class="token punctuation">,</span>
		Debug<span class="token punctuation">:</span>            traceConfig<span class="token punctuation">.</span>Debug<span class="token punctuation">,</span>
		Limit<span class="token punctuation">:</span>            <span class="token function">int</span><span class="token punctuation">(</span>traceConfig<span class="token punctuation">.</span>Limit<span class="token punctuation">)</span><span class="token punctuation">,</span>
		Overrides<span class="token punctuation">:</span>        overrides<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	tracer <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">NewStructLogger</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>logConfig<span class="token punctuation">)</span>

	tCtx <span class="token operator">:=</span> <span class="token operator">&amp;</span>tracers<span class="token punctuation">.</span>Context<span class="token punctuation">{</span>
		BlockHash<span class="token punctuation">:</span> txConfig<span class="token punctuation">.</span>BlockHash<span class="token punctuation">,</span>
		TxIndex<span class="token punctuation">:</span>   <span class="token function">int</span><span class="token punctuation">(</span>txConfig<span class="token punctuation">.</span>TxIndex<span class="token punctuation">)</span><span class="token punctuation">,</span>
		TxHash<span class="token punctuation">:</span>    txConfig<span class="token punctuation">.</span>TxHash<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> traceConfig<span class="token punctuation">.</span>Tracer <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> tracer<span class="token punctuation">,</span> err <span class="token operator">=</span> tracers<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>traceConfig<span class="token punctuation">.</span>Tracer<span class="token punctuation">,</span> tCtx<span class="token punctuation">,</span> tracerJSONConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Define a meaningful timeout of a single transaction trace</span>
	<span class="token keyword">if</span> traceConfig<span class="token punctuation">.</span>Timeout <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> timeout<span class="token punctuation">,</span> err <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">ParseDuration</span><span class="token punctuation">(</span>traceConfig<span class="token punctuation">.</span>Timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"timeout value: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Handle timeouts and RPC cancellations</span>
	deadlineCtx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token operator">&lt;-</span>deadlineCtx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>deadlineCtx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>DeadlineExceeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			tracer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"execution timeout"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">ApplyMessageWithConfig</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> tracer<span class="token punctuation">,</span> commitMessage<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> txConfig<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> result <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	result<span class="token punctuation">,</span> err <span class="token operator">=</span> tracer<span class="token punctuation">.</span><span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>result<span class="token punctuation">,</span> txConfig<span class="token punctuation">.</span>LogIndex <span class="token operator">+</span> <span class="token function">uint</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Logs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// BaseFee implements the Query/BaseFee gRPC method</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>k Keeper<span class="token punctuation">)</span> <span class="token function">BaseFee</span><span class="token punctuation">(</span>c context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>QueryBaseFeeRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>QueryBaseFeeResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctx <span class="token operator">:=</span> sdk<span class="token punctuation">.</span><span class="token function">UnwrapSDKContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

	params <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetParams</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	ethCfg <span class="token operator">:=</span> params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">.</span><span class="token function">EthereumConfig</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>eip155ChainID<span class="token punctuation">)</span>
	baseFee <span class="token operator">:=</span> k<span class="token punctuation">.</span><span class="token function">GetBaseFee</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ethCfg<span class="token punctuation">)</span>

	res <span class="token operator">:=</span> <span class="token operator">&amp;</span>types<span class="token punctuation">.</span>QueryBaseFeeResponse<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">if</span> baseFee <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		aux <span class="token operator">:=</span> sdkmath<span class="token punctuation">.</span><span class="token function">NewIntFromBigInt</span><span class="token punctuation">(</span>baseFee<span class="token punctuation">)</span>
		res<span class="token punctuation">.</span>BaseFee <span class="token operator">=</span> <span class="token operator">&amp;</span>aux
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// getChainID parse chainID from current context if not provided</span>
<span class="token keyword">func</span> <span class="token function">getChainID</span><span class="token punctuation">(</span>ctx sdk<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> chainID <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> chainID <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> haqqtypes<span class="token punctuation">.</span><span class="token function">ParseChainID</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">ChainID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>chainID<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</span></span></span></span> <!----></span> <!----></span></span></p></div><!----></div></div></div></div><div class="layout__main__content__aside__container" style="--height-banners:nullpx;" data-v-58560e81><div class="layout__main__content__aside aside__bottom__false" data-v-58560e81><!----></div><div class="layout__main__content__aside__banners" data-v-58560e81><a href="https://github.com/haqq-network/haqq/issues" target="_blank" data-v-58560e81><div data-v-31935645 data-v-58560e81><div class="container" data-v-31935645><svg width="100%" height="100%" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" class="icon" data-v-31935645><path d="M0.836491 13.7697C0.543598 14.0626 0.543598 14.5374 0.836492 14.8303C1.12939 15.1232 1.60426 15.1232 1.89715 14.8303L0.836491 13.7697ZM14.7729 1.95457C15.0658 1.66168 15.0658 1.1868 14.7729 0.893912C14.48 0.601019 14.0051 0.601019 13.7122 0.893913L14.7729 1.95457ZM14.6668 1H15.4168V0.25H14.6668V1ZM4.48498 0.25C4.07077 0.25 3.73498 0.585786 3.73498 1C3.73498 1.41421 4.07077 1.75 4.48498 1.75V0.25ZM13.9168 11.1818C13.9168 11.596 14.2526 11.9318 14.6668 11.9318C15.081 11.9318 15.4168 11.596 15.4168 11.1818H13.9168ZM1.89715 14.8303L14.7729 1.95457L13.7122 0.893913L0.836491 13.7697L1.89715 14.8303ZM14.6668 0.25H4.48498V1.75H14.6668V0.25ZM15.4168 11.1818V1H13.9168V11.1818H15.4168Z"></path></svg><div class="image" data-v-31935645><svg width="41" height="44" viewBox="0 0 41 44" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-31935645><path fill-rule="evenodd" clip-rule="evenodd" d="M4 1.8999H32C33.3807 1.8999 34.5 3.01919 34.5 4.3999V10.997L36 9.497V4.3999C36 2.19076 34.2091 0.399902 32 0.399902H4C1.79086 0.399902 0 2.19077 0 4.39991V39.5999C0 41.809 1.79086 43.5999 4 43.5999H32C34.2091 43.5999 36 41.809 36 39.5999V20.2096L34.5 21.7096V39.5999C34.5 40.9806 33.3807 42.0999 32 42.0999H4C2.61929 42.0999 1.5 40.9806 1.5 39.5999V4.39991C1.5 3.01919 2.61929 1.8999 4 1.8999ZM7.2 19.1999H26.2971L24.2971 21.1999H7.2V19.1999ZM7.2 15.7999H28.8V13.7999H7.2V15.7999ZM7.2 26.5999H16.2V24.5999H7.2V26.5999ZM20.8638 25.7372L20.7386 25.8624L20.6826 26.0303L18.9855 31.1215L18.4792 32.6406L19.9704 32.0571L24.8494 30.1479L24.9955 30.0908L25.1064 29.9798L37.9799 17.1063L39.7831 15.3032C40.9546 14.1316 40.9546 12.2321 39.7831 11.0606C38.6115 9.88898 36.712 9.88898 35.5404 11.0606L20.8638 25.7372ZM20.9149 30.0767L22.0496 26.6726L36.6011 12.1212C37.1869 11.5354 38.1366 11.5354 38.7224 12.1212C39.3082 12.707 39.3082 13.6567 38.7224 14.2425L37.4496 15.5153L36.2465 14.3122C35.9536 14.0193 35.4787 14.0193 35.1858 14.3122C34.8929 14.6051 34.8929 15.08 35.1858 15.3729L36.3889 16.576L24.5761 28.3888L23.6215 27.4342C23.3286 27.1413 22.8537 27.1413 22.5608 27.4342C22.2679 27.7271 22.2679 28.202 22.5608 28.4949L23.2349 29.1689L20.9149 30.0767Z" fill="var(--color-primary, blue)" data-v-31935645></path></svg></div><div class="h1" data-v-31935645>Found an Issue?</div><div class="h2" data-v-31935645>Help us improve this page by suggesting edits on GitHub.</div></div></div></a></div></div></div><div class="layout__main__gutter" data-v-58560e81><div data-v-15325c0d data-v-58560e81><div class="links" data-v-15325c0d><div class="links__wrapper" data-v-15325c0d><div class="links__container" data-v-15325c0d><a href="/basics/transactions.html" class="links__item links__item__left" data-v-15325c0d><div class="links__item__icon" data-v-15325c0d><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 64 64" data-v-15325c0d><title data-v-15325c0d>arrow-right</title><g stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" data-v-15325c0d><line fill="none" stroke-miterlimit="10" x1="61" y1="32" x2="3" y2="32" stroke-linecap="butt" data-v-15325c0d></line><polyline fill="none" stroke-miterlimit="10" points="21,14 3,32 21,50 " data-v-15325c0d></polyline></g></svg></div><div data-v-15325c0d><div class="links__label" data-v-15325c0d>Previous</div><div class="links__item__title" data-v-15325c0d>Transaction Lifecycle</div><div class="links__item__desc" data-v-15325c0d><div>This document describes the lifecycle of a transaction from creation to committed state changes on the EVM.</div></div></div></a></div></div><div class="links__wrapper" data-v-15325c0d><div class="links__container" data-v-15325c0d><a href="/basics/tokens.html" class="links__item links__item__right" data-v-15325c0d><div data-v-15325c0d><div class="links__label" data-v-15325c0d>Next</div><div class="links__item__title" data-v-15325c0d>Tokens</div><div class="links__item__desc" data-v-15325c0d><div>Learn about the the different types of tokens available in Haqq.</div></div></div><div class="links__item__icon" data-v-15325c0d><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 64 64" data-v-15325c0d><title data-v-15325c0d>arrow-right</title><g stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" data-v-15325c0d><line fill="none" stroke-miterlimit="10" x1="3" y1="32" x2="61" y2="32" stroke-linecap="butt" data-v-15325c0d></line><polyline fill="none" stroke-miterlimit="10" points="43,14 61,32 43,50 " data-v-15325c0d></polyline></g></svg></div></a></div></div></div></div></div><div class="layout__main__footer" data-v-58560e81><div data-v-732a47ec data-v-58560e81><div class="wrapper" data-v-732a47ec><div class="container" data-v-732a47ec><div class="footer__wrapper" data-v-732a47ec><!----><!----><div class="logo" data-v-732a47ec><div class="logo__item" data-v-732a47ec><a href="https://docs.haqq.network" target="_blank" rel="noreferrer noopener" tag="div" class="logo__image" data-v-732a47ec><img src="/haqq_logo.svg" data-v-732a47ec></a></div><div class="logo__item logo__link" data-v-732a47ec><a href="https://github.com/haqq-network" target="_blank" title="github" rel="noreferrer noopener" class="smallprint__item__links__item" data-v-732a47ec><svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" fill="#aaa" data-v-732a47ec><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" data-v-732a47ec></path></svg></a></div></div><div class="smallprint" data-v-732a47ec><div class="smallprint__item smallprint__item__links" data-v-732a47ec><!----></div><div class="smallprint__item__desc smallprint__item" data-v-732a47ec><div>This website is maintained by Haqq Network.</div></div></div></div></div></div></div></div></div></div><div class="sheet__sidebar" data-v-ec82e5e0 data-v-58560e81><!----> <!----></div><div class="sheet__sidebar" data-v-ec82e5e0 data-v-58560e81><!----> <!----></div><div class="sheet__sidebar sheet__sidebar__toc" data-v-ec82e5e0 data-v-58560e81><!----> <!----></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.38831a15.js" defer></script><script src="/assets/js/30.d7ec603a.js" defer></script><script src="/assets/js/27.4737527f.js" defer></script><script src="/assets/js/25.6eba2827.js" defer></script><script src="/assets/js/31.5d89a875.js" defer></script><script src="/assets/js/56.f235578c.js" defer></script><script src="/assets/js/40.1f91466a.js" defer></script><script src="/assets/js/16.9b62e906.js" defer></script><script src="/assets/js/13.06c4e874.js" defer></script><script src="/assets/js/87.000220cc.js" defer></script><script src="/assets/js/5.4145d160.js" defer></script><script src="/assets/js/11.66108a36.js" defer></script><script src="/assets/js/38.b36b40da.js" defer></script><script src="/assets/js/19.efb83fa7.js" defer></script><script src="/assets/js/18.6c4ab24b.js" defer></script><script src="/assets/js/26.d6542a64.js" defer></script>
  </body>
</html>
